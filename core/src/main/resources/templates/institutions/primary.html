<!DOCTYPE html>
<html>
<head th:replace="fragments/header :: header (datatables = true, checkbox = true)" />
<body class="top-navigation">
<div id="wrapper">
    <div id="page-wrapper" class="gray-bg">
        <div th:replace="fragments/topbar :: topbar (page = 'primaryInstitutions')" />

        <div class="wrapper wrapper-content">
            <div class="row">

                <div class="col-lg-12">
                    <div class="ibox">
                        <div class="ibox-title" style="line-height: 40px;">
                            <h5><em class="fa fa-list"></em> &nbsp; <span th:text="#{html.navbar.primaryInstitutions}"></span></h5>
                            <div class="ibox-tools">
                                <button onclick="primaryInstitutionService.addPrimaryInstitution();" type="button" class="btn btn-lg btn-primary" style="width:auto; margin-right:10px">
                                    <em class="fa fa-plus"></em>
                                    <span th:text="#{html.primaryinstitution.button.add}"></span>
                                </button>
                            </div>
                        </div>

                        <div class="ibox-content">
                            <p th:text="#{html.primaryinstitution.explainer}"></p>
                            <table id="primaryInstitutionTable" class="table table-striped table-hover listTable">
                                <thead>
                                <tr>
                                    <th class="col-md-3" th:text="#{html.entity.person.name}"></th>
                                    <th class="col-md-2" th:text="#{html.entity.person.username}"></th>
                                    <th class="col-md-3" th:text="#{html.entity.institution.primary.name}"></th>
                                    <th class="col-md-3" th:text="#{html.entity.institution.primary.number}"></th>
                                    <th class="col-md-1" th:text="#{html.control.operations}"></th>
                                </tr>
                                </thead>

                                <tbody>
                                <tr th:each="person : ${peopleWithPrimaryInstitution}">
                                    <td>
                                        <span th:text="${person.firstname() + ' ' + person.surname()}"></span>
                                    </td>
                                    <td>
                                        <span th:text="${person.username()}"></span>
                                    </td>
                                    <td>
                                        <span th:text="${person.primaryInstitutionName()}"></span>
                                    </td>
                                    <td>
                                        <span th:text="${person.primaryInstitutionNumber()}"></span>
                                    </td>
                                    <td>
                                        <a th:id="'changePrimary' + ${person.username()}" href="#" onclick="primaryInstitutionService.changePrimaryInstitution(this);"
                                           th:attr="data-username=${person.username()}, data-personname=${person.firstname() + ' ' + person.surname()}"
                                           style="color:black;">
                                            <em th:title="#{html.entity.institution.changePrimary.title}" class="fa fa-fw fa-pencil"></em>
                                        </a>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- primary institution modal -->
    <div class="modal fade" id="modal-primary-institution" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 id="modalHeaderText"></h4>
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">Ã—</span><span class="sr-only" th:text="#{html.control.button.cancel}"></span></button>
                </div>

                <div class="modal-body">
                    <input id="modalUsername" hidden>
                    <input id="modalPersonName" hidden>

                    <div class="form-horizontal">
                        <!-- User search section -->
                        <div id="userSearchSection">
                            <div class="form-group">
                                <label class="col-lg-12 control-label" th:text="#{html.primaryinstitution.modal.search.label}"></label>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-12">
                                    <input type="text" class="form-control" id="searchBoxPerson" autocomplete="off" th:placeholder="#{html.control.search}"/>
                                    <div id="inputAddonPerson" hidden="true">
                                        <span class="input-group-addon">
                                            <em class="fa fa-fw fa-times" onclick="$('#searchBoxPerson').val(''); $('#dropdownResultPerson').removeClass('open'); $('#searchBoxPerson').focus(); $('#inputAddonPerson').hide();"></em>
                                        </span>
                                    </div>

                                    <div id="dropdownResultPerson" class="dropdown">
                                        <ul id="searchResultDropDownMenuPerson" class="dropdown-menu" style="width: 100%; padding-left: 15px; padding-right: 15px; line-height: 25px;">
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Institution selection section (hidden initially) -->
                        <div id="institutionSelectSection" style="display: none;">
                            <div class="form-group">
                                <label class="col-lg-12 control-label">
                                    <span th:text="#{html.primaryinstitution.modal.select.label}"></span>
                                    <span id="selectedPersonName"></span>
                                </label>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-12">
                                    <select id="institutionSelect" class="form-control">
                                        <option value="" th:text="#{html.primaryinstitution.modal.select.placeholder}"></option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-12">
                                    <button type="button" class="btn btn-primary" onclick="primaryInstitutionService.savePrimaryInstitution()">
                                        <span th:text="#{html.control.button.save}"></span>
                                    </button>
                                    <button type="button" id="backButton" class="btn btn-default" onclick="primaryInstitutionService.resetModal()">
                                        <span th:text="#{html.control.button.back}"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <!-- primary institution modal end -->

</div>

<style>
    .dropdown.open .dropdown-menu {
        display: block;
    }
    .dropdown-menu {
        max-height: 300px;
        overflow-y: auto;
    }
</style>

<div th:replace="fragments/footer :: scripts (datatables = true, checkbox = true)" />
<script th:inline="javascript">
    /*<![CDATA[*/

    /*[+
        var searchTxt = [[#{html.datatables.search}]];
        var dropdownTxt = [[#{html.datatables.dropdown}]];
        var infoDefaultTxt = [[#{html.datatables.info.default}]];
        var infoEmptyTxt = [[#{html.datatables.info.empty}]];
        var infoFilteredTxt = [[#{html.datatables.info.filtered}]];
        var prevTxt = [[#{html.datatables.prev}]];
        var nextTxt = [[#{html.datatables.next}]];

        var modalHeaderAdd = [[#{html.primaryinstitution.modal.header.add}]];
        var modalHeaderEdit = [[#{html.primaryinstitution.modal.header.edit}]];

        var primaryInstitutionSuccess = [[#{html.entity.institution.primary.success}]];
        var primaryInstitutionError = [[#{html.entity.institution.primary.error}]];

        var primaryInstitutionRestUrl = [[@{/rest/institution/primary/}]];
    +]*/

    var token = $("meta[name='_csrf']").attr("content");

    var primaryInstitutionService;
    var searchService;

    $(document).ready(function(){
        primaryInstitutionService = new PrimaryInstitutionService();
        primaryInstitutionService.initTable();

        searchService = new SearchService();
        $('#searchBoxPerson').on('input', function() {
            searchService.executeQuery();
        });
    });

    function PrimaryInstitutionService() {
        var self = this;
        var isEditMode = false;

        // Initialize DataTable
        this.initTable = function() {
            $('#primaryInstitutionTable').DataTable({
                'columnDefs': [{
                    "targets": 4,
                    "orderable": false
                }],
                'paging':    false,
                'ordering':  true,
                'info':      true,
                'language': {
                    "search":       searchTxt,
                    "lengthMenu":   dropdownTxt,
                    "info":         infoDefaultTxt,
                    "zeroRecords":  infoEmptyTxt,
                    "infoEmpty":    "",
                    "infoFiltered": infoFilteredTxt,
                    "paginate": {
                        "next": nextTxt,
                        "previous": prevTxt
                    }
                }
            });
        }

        // Open modal to add new primary institution
        this.addPrimaryInstitution = function() {
            isEditMode = false;
            self.resetModal();
            $("#modalHeaderText").text(modalHeaderAdd);
            $("#modal-primary-institution").modal("show");
        }

        // Open modal to change existing primary institution
        this.changePrimaryInstitution = function(elem) {
            var username = $(elem).data("username");
            var personName = $(elem).data("personname");

            isEditMode = true;
            self.resetModal();
            $("#modalHeaderText").text(modalHeaderEdit + " " + personName);

            // Show modal first
            $("#modal-primary-institution").modal("show");

            // Then load institutions for the user
            self.loadInstitutionsForUser(username, personName);
        }

        // Reset modal to initial state
        this.resetModal = function() {
            $("#modalUsername").val("");
            $("#modalPersonName").val("");
            $("#searchBoxPerson").val("");
            $("#institutionSelect").empty();
            $("#institutionSelect").append("<option value=''></option>");
            searchService.updateDropdown(null);

            $("#userSearchSection").show();
            $("#institutionSelectSection").hide();
        }

        // Load institutions for selected user
        this.loadInstitutionsForUser = function(username, personName) {
            $("#modalUsername").val(username);
            $("#modalPersonName").val(personName);
            $("#selectedPersonName").text(": " + personName);

            // Clear search dropdown
            $("#dropdownResultPerson").removeClass("open");
            $("#searchResultDropDownMenuPerson").empty();

            // Load institutions for this user
            $.ajax({
                url: primaryInstitutionRestUrl + "institutions?username=" + username,
                method: "GET",
                success: function(response) {
                    $("#institutionSelect").empty();
                    $("#institutionSelect").append("<option value=''></option>");

                    if (response && response.length > 0) {
                        for (var i = 0; i < response.length; i++) {
                            var institution = response[i];
                            var optionText = institution.institutionName + " (" + institution.institutionNumber + ")";
                            var optionValue = institution.institutionNumber;
                            var selected = institution.primary ? " selected" : "";
                            $("#institutionSelect").append("<option value='" + optionValue + "'" + selected + ">" + optionText + "</option>");
                        }
                    }

                    $("#userSearchSection").hide();
                    $("#institutionSelectSection").show();

                    // Hide back button if in edit mode
                    if (isEditMode) {
                        $("#backButton").hide();
                    } else {
                        $("#backButton").show();
                    }
                },
                error: function() {
                    alert(primaryInstitutionError);
                }
            });
        }

        // Save the selected primary institution
        this.savePrimaryInstitution = function() {
            var username = $("#modalUsername").val();
            var institutionNumber = $("#institutionSelect").val();

            if (!institutionNumber) {
                return;
            }

            $.ajax({
                url: primaryInstitutionRestUrl + "save",
                method: "POST",
                contentType: "application/json",
                headers: {
                    "X-CSRF-TOKEN": token
                },
                data: JSON.stringify({
                    username: username,
                    institutionNumber: institutionNumber
                }),
                success: function(response) {
                    window.location.reload();
                },
                error: function() {
                    alert(primaryInstitutionError);
                }
            });
        }
    }

    function SearchService() {
        this.executeQuery = function() {
            $('#inputAddonPerson').show();
            var value = $('#searchBoxPerson').val();
            if (value.length >= 3) {
                var query = primaryInstitutionRestUrl + "search?query=" + $('#searchBoxPerson').val();
                $.ajax({
                    url: query,
                    method: "GET",
                    success: function(response) {
                        if (response == null || response.length < 1) {
                            searchService.updateDropdown(null);
                            return;
                        }
                        var resultSet = [];
                        for (var j = 0; j < response.length; j++) {
                            var hit = {
                                username: response[j].username,
                                firstName: response[j].firstName,
                                familyName: response[j].familyName,
                                institutionCount: response[j].institutionCount,
                            };
                            resultSet.push(hit);
                        }
                        searchService.updateDropdown(resultSet);
                    },
                    error: function(xhr, status, error) {
                        searchService.updateDropdown(null);
                    }
                });
            } else {
                searchService.updateDropdown(null);
            }
        }

        this.updateDropdown = function(resultSet) {
            if (resultSet && resultSet.length > 0) {
                $("#searchResultDropDownMenuPerson").empty();
                for (var i = 0; i < resultSet.length; i++) {
                    var guiValue = resultSet[i].firstName + " " + resultSet[i].familyName + " (" + resultSet[i].username + ") - " + resultSet[i].institutionCount + " institution(er)";
                    var username = resultSet[i].username;
                    var personName = resultSet[i].firstName + " " + resultSet[i].familyName;
                    $("#searchResultDropDownMenuPerson").append("<a href='#' style='color: black;' onclick=\"searchService.select('" + username + "', '" + personName.replace(/'/g, "\\'") + "')\"><li>" + guiValue + "</li></a>");
                }
                $("#dropdownResultPerson").addClass("open");
            } else {
                $("#dropdownResultPerson").removeClass("open");
            }
        }

        this.select = function(username, personName) {
            $("#dropdownResultPerson").removeClass("open");
            $("#searchBoxPerson").val("");
            $('#inputAddonPerson').hide();

            primaryInstitutionService.loadInstitutionsForUser(username, personName);
        }
    }

    /*]]>*/
</script>
</body>
</html>